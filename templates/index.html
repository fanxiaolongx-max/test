{% extends "base.html" %}
{% block content %}
<div class="text-center">
    <div class="flex-1">
        <h3 class="text-2xl font-semibold mb-4 text-left">所有发布</h3>
        <form method="get" action="/" class="mb-4 space-y-2 md:space-y-0 md:space-x-2 md:flex items-center">
            {% for field in fields_to_filter %}
            <input type="text" name="{{ field['name'] }}" placeholder="按{{ field['label'] }}筛选..." class="px-3 py-2 rounded-md border border-gray-300 w-full md:w-auto flex-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="{{ request.args.get(field['name'], '') }}">
            {% endfor %}
            <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 w-full md:w-auto">筛选</button>
        </form>
        {% if listings %}
        <div class="overflow-x-auto bg-white rounded-lg shadow-md">
            <table class="table-auto w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        {% for field in fields_to_display %}
                        <th scope="col" class="min-w-0">
                            <a href="?sort={{ field['name'] }}&order={{ 'desc' if request.args.get('sort') == field['name'] and request.args.get('order') == 'asc' else 'asc' }}{{ '&' + request.query_string.decode('utf-8').replace('sort=' + request.args.get('sort', '') + '&', '').replace('order=' + request.args.get('order', ''), '') }}">
                                {{ field['label'] }}
                            {% if request.args.get('sort') == field['name'] %}<span class="sort-icon">{{ '▲' if request.args.get('order') == 'asc' else '▼' }}</span>{% endif %}
                            </a>
                        </th>
                        {% endfor %}
                        <th scope="col">状态</th>
                        <th scope="col">发布日期</th>
                        <th scope="col">操作</th>
                    </tr>
                </thead>
                <tbody>
                {% for listing in listings %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        {% for field in fields_to_display %}
                        <td>
                            {% if field['type'] == 'file' %}
                                {% if listing['data'][field['name']] %}
                                    <a href="{{ url_for('uploaded_file', filename=listing['data'][field['name']]) }}" class="text-blue-500 hover:underline">查看文件</a>
                                {% else %}
                                    N/A
                                {% endif %}
                            {% else %}
                                {{ listing['data'][field['name']] }}
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td>
                            {% set status_map = {'open': '开放', 'closed': '已完成'} %}
                            {{ status_map.get(listing['status'], '未知') }}
                        </td>
                        <td>{{ listing['post_date'] }}</td>
                        <td class="space-x-2 whitespace-nowrap">
                            {% if 'username' in session %}
                                <a href="{{ url_for('view_details', demand_id=listing['id']) }}" class="text-sm text-blue-600 hover:underline">查看详情</a>
                                {% if session['is_admin'] or (listing['user_id'] == session['user_id'] and listing['status'] == 'open') %}
                                    <a href="{{ url_for('edit_demand', demand_id=listing['id']) }}" class="text-sm text-blue-600 hover:underline">编辑</a>
                                    <a href="{{ url_for('delete_demand', demand_id=listing['id']) }}" class="text-sm text-red-600 hover:underline">删除</a>
                                {% endif %}
                            {% else %}
                                <a href="{{ url_for('login') }}" class="text-sm text-gray-500 hover:underline">登录</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-gray-500 mt-4">暂无发布内容</p>
        {% endif %}
    </div>
</div>
{% endblock %}
